# 错误添加快速指南

## ⚠️ 重要说明
**错误键命名规则**: `NewCodeError` 的第二个参数格式为 `"error.{文件名}.{变量名小驼峰}"`，其中：
- `{文件名}` 必须与对应的 `.go` 文件名一致
- `{变量名小驼峰}` 必须与错误变量名的小驼峰形式一致
- **必须使用多语言键**，不能直接使用中文或其他语言的文本

例如：
- `OtaRetryStatusError` → `"error.ota.otaRetryStatusError"`
- `DuplicateUsername` → `"error.user.usernameAlreadyRegistered"`
- `DeviceTimeOut` → `"error.device.deviceTimeout"`
- `Limit` → `"error.sys.limit"` ✅ (正确)
- `Limit` → `"已到达上限"` ❌ (错误，直接使用中文)

## 🚀 快速添加新错误的步骤

### 1️⃣ 确定错误模块
根据错误性质选择对应模块：
- **系统错误** → `sys.go` (100000-199999)
- **用户错误** → `user.go` (1000000-1999999) 
- **设备错误** → `device.go` (2000000-2999999)
- **媒体错误** → `media.go` (3000000-3999999)
- **文件错误** → `file.go` (1000000-1999999)
- **OTA错误** → `ota.go` (2100000-2199999)
- **用户数据错误** → `ud.go` (4000000-4999999)

### 2️⃣ 在对应文件中添加错误定义
```go
// 在相应的 .go 文件中添加
var (
    YourErrorName = NewCodeError(ModuleError+NextNumber, "error.文件名.变量名小驼峰") // 中文注释说明
)
```

**注意**: 每个错误定义后面都应该添加中文注释，注释内容应该与 `zh_CN.json` 中的中文翻译保持一致。

**示例：**
```go
// 在 user.go 中添加
var (
    PasswordTooWeak = NewCodeError(UserError+35, "error.user.passwordTooWeak") // 密码强度不足
)

// 在 file.go 中添加
var (
    DownloadFailed = NewCodeError(FileError+2, "error.file.downloadFailed") // 文件下载失败
)

// 在 ota.go 中添加
var (
    OtaRetryStatusError = NewCodeError(OtaError+1, "error.ota.otaRetryStatusError") // 升级状态不允许重新升级
)
```

### 3️⃣ 在语言包中添加翻译
在 `i18n/en_US.json` 中添加：
```json
{
  "error.user.passwordTooWeak": "Password is too weak, please use at least 8 characters with numbers and symbols",
  "error.file.downloadFailed": "File download failed, please try again",
  "error.ota.otaRetryStatusError": "OTA status does not allow retry"
}
```

### 4️⃣ 添加其他语言支持（可选）
```json
// 创建 zh_CN.json 或添加到现有文件
{
  "error.user.passwordTooWeak": "密码强度不足，请使用至少8位包含数字和符号的密码",
  "error.file.downloadFailed": "文件下载失败，请重试",
  "error.ota.otaRetryStatusError": "OTA状态不允许重试"
}
```

## 📋 错误码分配表

| 模块 | 当前范围 | 下一个可用码 |
|------|----------|--------------|
| 系统 | 100000-100027 | 100028 |
| 用户 | 1000000-1000034 | 1000035 |
| 设备 | 2000000-2000007 | 2000008 |
| 媒体 | 3000000-3000011 | 3000012 |
| OTA | 2100000-2100003 | 2100004 |
| 文件 | 1000000-1000001 | 1000002 |
| 用户数据 | 4000000-4000001 | 4000002 |

## 🎯 命名规范

### 错误变量命名
- ✅ `PasswordTooWeak` - 清晰表达含义
- ✅ `DeviceConnectionTimeout` - 具体明确
- ❌ `Err1` - 不明确
- ❌ `PwdErr` - 缩写不清晰

### 消息键命名
**格式**: `error.{文件名}.{变量名小驼峰}`

- ✅ `error.user.passwordTooWeak` (变量: `PasswordTooWeak`)
- ✅ `error.device.deviceTimeout` (变量: `DeviceTimeOut`)
- ✅ `error.file.downloadFailed` (变量: `DownloadFailed`)
- ✅ `error.ota.otaRetryStatusError` (变量: `OtaRetryStatusError`)
- ❌ `error.user.err1` (不明确)
- ❌ `error.user.pwdErr` (缩写不清晰)

## 💡 最佳实践

### 错误消息设计
- **用户友好**: "密码强度不足" 而不是 "密码验证失败"
- **具体明确**: "用户名长度必须在6-20个字符之间"
- **可操作**: "请检查设备电源连接" 而不是 "设备错误"

### 中文注释规范
- **必须添加**: 每个错误定义后面都应该添加中文注释
- **内容一致**: 注释内容必须与 `zh_CN.json` 中的中文翻译保持一致
- **格式统一**: 使用 `// 中文说明` 的格式，与代码保持适当间距
- **简洁明了**: 注释应该简洁明了，直接说明错误的含义

### 错误码管理
- 按模块顺序递增分配
- 不要跳过错误码
- 为未来扩展预留空间

### 命名一致性
- **变量名**: 使用大驼峰命名法 (PascalCase)
- **错误键**: 使用小驼峰命名法 (camelCase)
- **对应关系**: 错误键的第三部分必须是变量名的小驼峰形式

## 🔧 使用示例

### 创建错误
```go
// 基本使用
return errors.PasswordTooWeak

// 添加自定义消息
return errors.PasswordTooWeak.WithMsg("当前密码不符合安全要求")

// 添加格式化消息
return errors.PasswordTooWeak.WithMsgf("密码 '%s' 强度不足", password)
```

### 获取多语言消息
```go
// 获取默认语言
msg := error.GetI18nMsg("")

// 获取指定语言
msg := error.GetI18nMsg("zh_CN")
```

## ⚠️ 注意事项

1. **错误码唯一性**: 确保不重复使用已存在的错误码
2. **语言包同步**: 添加错误后记得更新语言包
3. **向后兼容**: 不要修改已发布的错误码
4. **测试验证**: 添加测试用例验证新错误
5. **多语言规范**: 必须使用多语言键，不能直接使用中文或其他语言文本
6. **命名一致性**: 错误键必须遵循 `error.{文件名}.{变量名小驼峰}` 格式
7. **中文注释**: 每个错误定义后面都必须添加中文注释，注释内容与 `zh_CN.json` 保持一致

## 🆘 常见问题

**Q: 如何确定错误应该放在哪个模块？**
A: 根据错误的业务领域确定，如用户登录相关放在user模块，设备连接相关放在device模块。

**Q: 错误码用完了怎么办？**
A: 可以扩展错误码范围，如从1000000扩展到10000000，但需要更新文档。

**Q: 如何添加新的语言支持？**
A: 创建新的语言包文件（如fr_FR.json），翻译所有错误消息，并在i18ns包中注册。

**Q: 可以直接在错误定义中使用中文吗？**
A: 不可以！必须使用多语言键格式，如 `"error.sys.limit"`，然后在语言包中提供翻译。直接使用中文会导致多语言系统无法正常工作。

**Q: 为什么要在错误定义后面添加中文注释？**
A: 添加中文注释有助于开发者快速理解错误的含义，特别是在代码审查和调试时。注释内容应该与 `zh_CN.json` 中的翻译保持一致，确保注释的准确性。

---

**快速参考版本** - 详细规范请参考 `多语言错误处理规范文档.md`
